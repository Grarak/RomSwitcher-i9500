#!/sbin/busybox sh

cd /

mount -t proc proc /proc
mount -t sysfs sys /sys

mkdir -p /dev/block
mkdir /dev/input

for i in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14; do
	event=$((0+$i))
	minor=$((64+$i))
	mknod /dev/input/event$event c 13 $minor
done

for i in 0 1 2; do
	block=$((19+$i))
	minor=$((11+$i))
	mknod /dev/block/mmcblk0p$block b 259 $minor
done

mknod /dev/block/loop0 b 7 0

mount -t ext4 /dev/block/mmcblk0p21 /data

out() {
	umount -f /system
	umount -f /data

	chmod 755 /int.0
	chmod 644 /*.universal5410
	chmod 644 /*.rc
	chmod 644 /*.prop
	chmod -R 755 /lib

	rm -f /init
	mv -f /init.0 /init

	exec /init
}

ROM=`cat /data/media/.rom`
[ -e /data/media/.rom ] || ROM=0

if grep -q bootmode=2 /proc/cmdline || [ -e /data/media/rebootrs ]; then
	rm -f /data/media/rebootrs
	mv -f /res/etc /
	mv -f /res/aosp43/* /
	mv -f /res/recovery/* /
	out
fi

mkdir -p /data/media/0/romswitcher-tmp
if [ -e /data/media/0/romswitcher-tmp/manualboot ]; then
	if [ -e /data/media/.nextboot ]; then
		rm -f /data/media/.nextboot
	else
		mv -f /res/etc /
		mv -f /res/aosp43/* /
		mv -f /res/recovery/* /
		mv -f /init.rc.2 /init.rc
		out
	fi
fi

[ -e /data/media/.nextboot ] && rm -f /data/media/.nextboot

if [ "$ROM" == "0" ]; then
	mount -t ext4 /dev/block/mmcblk0p20 /system
	if [ -f /system/framework/twframework.jar ]; then
		mv -f /res/sec422/* /
		if [ -f /system/framework/framework-miui-res.apk ]; then
				mv -f /res/miui422/* /
		fi
	else
		mv -f /res/aosp43/* /
	fi
elif [ "$ROM" == "3" ]; then
	mount -t ext4 /dev/block/mmcblk0p19 /system
	if [ -f /system/framework/twframework.jar ]; then
		mv -f /res/sec422/* /
		if [ -f /system/framework/framework-miui-res.apk ]; then
			mv -f /res/miui422/* /
		fi
	else
		mv -f /res/aosp43/* /
	fi
	mv -f /fstab.universal5410.2 /fstab.universal5410
	mv -f /init.universal5410.rc.fourth /init.universal5410.rc
else
	mv -f /res/aosp43/* /
	mv -f /fstab.universal5410.2 /fstab.universal5410
	if [ "$ROM" == "1" ]; then
		mv -f /init.universal5410.rc.second /init.universal5410.rc
	elif [ "$ROM" == "2" ]; then
		mv -f /init.universal5410.rc.third /init.universal5410.rc
	fi
fi

out
