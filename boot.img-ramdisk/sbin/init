#!/sbin/busybox sh

cd /

mount -t proc proc /proc
mount -t sysfs sys /sys

mkdir -p /dev/block
mkdir /dev/input

for i in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14; do
	event=$((0+$i))
	minor=$((64+$i))
	mknod /dev/input/event$event c 13 $minor
done

for i in 0 1 2; do
	block=$((19+$i))
	minor=$((11+$i))
	mknod /dev/block/mmcblk0p$block b 259 $minor
done

mknod /dev/block/loop0 b 7 0

mount -t ext4 /dev/block/mmcblk0p21 /data

if ! grep -q bootmode=2 /proc/cmdline || [ ! -e /data/media/rebootrs ]; then

	echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
	KEY=`/sbin/ext/evkey -u -t 1000 /dev/input/event11`

	if [ "$KEY" == "172" ]; then    # HOME
		KEYREC=`/sbin/ext/evkey -u -t 500 /dev/input/event11`
		if [ "$KEYREC" == "172" ]; then
			sleep 0.3
			echo 300 > /sys/devices/virtual/timed_output/vibrator/enable
			echo 1 > /data/media/rebootrs
		else
			echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
			echo 0 > /data/media/.rom
		fi
	elif [ "$KEY" == "116" ]; then  # POWER
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		echo 1 > /data/media/.rom
	elif [ "$KEY" == "114" ]; then  # VOLUME DOWN
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		echo 2 > /data/media/.rom
	elif [ "$KEY" == "115" ]; then  # VOLUME UP
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		sleep 0.3
		echo 50 > /sys/devices/virtual/timed_output/vibrator/enable
		echo 3 > /data/media/.rom
	fi
fi

ROM=`cat /data/media/.rom`
[ -e /data/media/.rom ] || ROM=0

if grep -q bootmode=2 /proc/cmdline || [ -e /data/media/rebootrs ]; then
	rm -f /data/media/rebootrs
	mv -f /res/etc /
	mv -f /res/aosp43/* /
	mv -f /res/recovery/* /
else
	if [ "$ROM" == "0" ]; then
		mount -t ext4 /dev/block/mmcblk0p20 /system
		if [ -f /system/framework/twframework.jar ]; then
			mv -f /res/sec422/* /
		else
			mv -f /res/aosp43/* /
		fi
	elif [ "$ROM" == "3" ]; then
		mount -t ext4 /dev/block/mmcblk0p19 /system
                if [ -f /system/framework/twframework.jar ]; then
			mv -f /res/sec422/* /
		else
			mv -f /res/aosp43/* /
		fi
		mv -f /fstab.universal5410.2 /fstab.universal5410
		mv -f /init.universal5410.rc.fourth /init.universal5410.rc
	else
		mv -f /res/aosp43/* /
		mv -f /fstab.universal5410.2 /fstab.universal5410
		if [ "$ROM" == "1" ]; then
			mount -t ext4 /data/media/.secondrom/system.img /system
			mv -f /init.universal5410.rc.second /init.universal5410.rc
		elif [ "$ROM" == "2" ]; then
			mount -t ext4 /data/media/.thirdrom/system.img /system
			mv -f /init.universal5410.rc.third /init.universal5410.rc
		fi
	fi
fi

if [ -f /system/framework/framework-pac.jar ]; then
	sed 's|/system/framework/framework.jar:|/system/framework/framework.jar:/system/framework/framework-pac.jar:|' -i /init.rc
fi

umount -f /system
umount -f /data

chmod 755 /int.0
chmod 644 /*.universal5410
chmod 644 /*.rc
chmod 644 /*.prop
chmod -R 755 /lib

rm -f /init
mv -f /init.0 /init

exec /init
